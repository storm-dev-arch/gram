INDEX_HTML = r"""<!DOCTYPE html>
<html lang="ru" data-theme="system">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>KTYISGRAM</title>

  <style>
    /* ===========================
       ТЕМЫ, ПЕРЕМЕННЫЕ, ГРАДИЕНТ
       =========================== */

    :root {
      --bg: #0f1220;
      --bg-elev: #151a2f;
      --bg-soft: #0b0e1c;
      --text: #e8ecf9;
      --muted: #a9b1cc;
      --brand: #7c5cff;
      --brand-2: #00d2ff;
      --accent: #1ee19e;
      --danger: #ff5d6c;
      --warn: #ffcc66;
      --ok: #6ee780;
      --border: #25314d;
      --shadow: rgba(0, 0, 0, 0.25);

      --grad-1: #3a2ce2;
      --grad-2: #7c3aed;
      --grad-3: #00d2ff;
      --grad-4: #1ee19e;

      --r-xl: 16px;
      --r-lg: 12px;
      --r-md: 10px;
      --r-sm: 8px;

      --g-xl: 28px;
      --g-lg: 20px;
      --g-md: 14px;
      --g-sm: 10px;
      --g-xs: 6px;

      --t-fast: 140ms;
      --t-med: 240ms;
      --t-slow: 420ms;

      --header-h: 64px;
      --sidebar-w: 280px;
      --max-w: 1120px;
      --input-h: 52px;

      --mono: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      --sans: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Inter, "Helvetica Neue", Arial, "Noto Sans", "Apple Color Emoji", "Segoe UI Emoji";
    }

    [data-theme="light"] {
      --bg: #f6f7fb;
      --bg-elev: #ffffff;
      --bg-soft: #eef2fb;
      --text: #111424;
      --muted: #56607a;
      --brand: #5b52ff;
      --brand-2: #00a9df;
      --accent: #10b981;
      --danger: #ef4444;
      --warn: #f59e0b;
      --ok: #16a34a;
      --border: #d9e0ee;
      --shadow: rgba(16, 24, 40, 0.06);

      --grad-1: #5b52ff;
      --grad-2: #7c3aed;
      --grad-3: #00b3eb;
      --grad-4: #10b981;
    }

    [data-theme="dark"] {
      --bg: #0f1220;
      --bg-elev: #151a2f;
      --bg-soft: #0b0e1c;
      --text: #e8ecf9;
      --muted: #a9b1cc;
      --brand: #7c5cff;
      --brand-2: #00d2ff;
      --accent: #1ee19e;
      --danger: #ff5d6c;
      --warn: #ffcc66;
      --ok: #6ee780;
      --border: #25314d;
      --shadow: rgba(0, 0, 0, 0.25);

      --grad-1: #3a2ce2;
      --grad-2: #7c3aed;
      --grad-3: #00d2ff;
      --grad-4: #1ee19e;
    }

    html, body {
      height: 100%;
    }
    body {
      margin: 0;
      font-family: var(--sans);
      color: var(--text);
      background:
        radial-gradient(1200px 800px at 10% -5%, rgba(124,92,255,0.18), transparent 60%),
        radial-gradient(1000px 700px at 90% 105%, rgba(0,210,255,0.18), transparent 60%),
        linear-gradient(180deg, var(--bg) 0%, var(--bg-soft) 100%);
      background-attachment: fixed;
      overflow: hidden;
    }

    .veil {
      position: fixed;
      inset: -20% -20% -20% -20%;
      background:
        radial-gradient(36% 40% at 12% 18%, rgba(58,44,226,0.25), transparent 60%),
        radial-gradient(30% 30% at 82% 86%, rgba(30,225,158,0.22), transparent 60%),
        radial-gradient(25% 25% at 58% 45%, rgba(0,210,255,0.18), transparent 60%);
      filter: blur(12px) saturate(110%);
      animation: floaty 24s ease-in-out infinite alternate;
      pointer-events: none;
      z-index: 0;
    }
    @keyframes floaty {
      0%   { transform: translate3d(0,0,0) scale(1); opacity: 0.8; }
      45%  { transform: translate3d(-2%, -1%, 0) scale(1.02); opacity: 0.9; }
      100% { transform: translate3d(3%, 2%, 0) scale(1.03); opacity: 0.85; }
    }

    /* ===========================
       СЕТКА, ОБЩИЕ ЭЛЕМЕНТЫ
       =========================== */

    .app {
      position: relative;
      z-index: 1;
      height: 100%;
      display: grid;
      grid-template-rows: var(--header-h) 1fr;
      grid-template-columns: 1fr;
    }

    .header {
      height: var(--header-h);
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 0 var(--g-lg);
      backdrop-filter: saturate(130%) blur(10px);
      background: linear-gradient(180deg, rgba(0,0,0,0.18), rgba(0,0,0,0)) ;
      box-shadow: 0 1px 0 var(--border);
    }

    .brand {
      display: flex;
      align-items: center;
      gap: var(--g-sm);
      font-weight: 700;
      letter-spacing: 0.4px;
    }
    .brand-logo {
      width: 28px;
      height: 28px;
      background: conic-gradient(from 120deg, var(--grad-1), var(--grad-2), var(--grad-3), var(--grad-4), var(--grad-1));
      border-radius: 10px;
      box-shadow: 0 4px 16px rgba(124,92,255,0.35), inset 0 0 12px rgba(255,255,255,0.15);
    }
    .brand-name {
      font-size: 16px;
    }

    .actions {
      display: flex;
      align-items: center;
      gap: var(--g-sm);
    }

    .btn {
      display: inline-flex;
      align-items: center;
      gap: 8px;
      border: 1px solid var(--border);
      background: linear-gradient(180deg, var(--bg-elev), var(--bg-soft));
      color: var(--text);
      padding: 8px 12px;
      border-radius: var(--r-md);
      cursor: pointer;
      transition: transform var(--t-med) ease, background var(--t-med) ease, border-color var(--t-med) ease;
      user-select: none;
      text-decoration: none;
      font-weight: 600;
      box-shadow: 0 6px 16px var(--shadow);
    }
    .btn:hover {
      transform: translateY(-1px);
      border-color: color-mix(in oklab, var(--border), var(--brand) 40%);
    }
    .btn:active {
      transform: translateY(0);
    }
    .btn.primary {
      border: 1px solid color-mix(in oklab, var(--border), var(--brand) 50%);
      background: linear-gradient(180deg, color-mix(in oklab, var(--bg-elev), var(--brand) 12%), var(--bg-elev));
      box-shadow: 0 6px 16px rgba(124,92,255,0.25);
    }

    .theme-toggle {
      border-radius: 999px;
      padding: 6px 10px;
    }

    .layout {
      height: calc(100vh - var(--header-h));
      display: grid;
      grid-template-columns: var(--sidebar-w) 1fr;
      gap: var(--g-lg);
      padding: var(--g-lg);
    }

    .panel {
      border: 1px solid var(--border);
      background: linear-gradient(180deg, var(--bg-elev), var(--bg));
      border-radius: var(--r-xl);
      box-shadow: 0 12px 24px var(--shadow);
      overflow: hidden;
    }

    .sidebar {
      display: grid;
      grid-template-rows: auto 1fr auto;
      min-height: 0;
    }

    .tabs {
      display: grid;
      grid-template-columns: repeat(4, 1fr);
      gap: 0;
      border-bottom: 1px solid var(--border);
      background: linear-gradient(180deg, var(--bg-elev), var(--bg));
    }
    .tab {
      text-align: center;
      padding: 12px 4px;
      font-weight: 700;
      letter-spacing: 0.3px;
      cursor: pointer;
      color: var(--muted);
      transition: color var(--t-med) ease, background var(--t-med) ease;
      border-bottom: 2px solid transparent;
    }
    .tab.active {
      color: var(--text);
      border-bottom: 2px solid color-mix(in oklab, var(--brand), white 0%);
      background: linear-gradient(180deg, color-mix(in oklab, var(--bg-elev), var(--brand) 6%), var(--bg-elev));
    }

    .sidebar-body {
      padding: var(--g-lg);
      overflow: auto;
    }

    .sidebar-footer {
      border-top: 1px solid var(--border);
      padding: var(--g-md);
      display: flex;
      gap: var(--g-sm);
      justify-content: space-between;
      align-items: center;
      background: linear-gradient(180deg, var(--bg), var(--bg-elev));
    }

    .kbadge {
      font-family: var(--mono);
      font-size: 12px;
      color: var(--muted);
      border: 1px dashed var(--border);
      padding: 4px 6px;
      border-radius: var(--r-sm);
    }

    /* ===========================
       ЧАТ
       =========================== */

    .chat {
      display: grid;
      grid-template-rows: auto 1fr auto;
      min-height: 0;
    }

    .chat-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: var(--g-md) var(--g-lg);
      border-bottom: 1px solid var(--border);
      background: linear-gradient(180deg, var(--bg-elev), var(--bg));
    }

    .search {
      display: flex;
      align-items: center;
      gap: 8px;
      background: linear-gradient(180deg, var(--bg-elev), var(--bg));
      border: 1px solid var(--border);
      border-radius: var(--r-md);
      padding: 6px 10px;
      min-width: 240px;
      transition: border-color var(--t-med) ease;
    }
    .search input {
      flex: 1;
      background: transparent;
      color: var(--text);
      outline: none;
      border: none;
      font-size: 14px;
    }
    .search:focus-within {
      border-color: color-mix(in oklab, var(--border), var(--brand) 40%);
    }

    .chat-scroll {
      overflow: auto;
      padding: var(--g-lg);
      display: grid;
      gap: var(--g-md);
      align-content: start;
      background:
        radial-gradient(600px 400px at 15% 5%, rgba(124,92,255,0.10), transparent 60%),
        radial-gradient(700px 500px at 85% 98%, rgba(30,225,158,0.10), transparent 60%),
        linear-gradient(180deg, var(--bg), var(--bg));
    }

    .date-divider {
      text-align: center;
      position: sticky;
      top: 6px;
      z-index: 2;
    }
    .date-chip {
      display: inline-flex;
      align-items: center;
      gap: 8px;
      padding: 6px 12px;
      border-radius: 999px;
      border: 1px solid var(--border);
      background: linear-gradient(180deg, var(--bg-elev), var(--bg));
      color: var(--muted);
      font-weight: 700;
      letter-spacing: 0.3px;
      box-shadow: 0 8px 20px var(--shadow);
    }

    .msg {
      display: grid;
      grid-template-columns: 40px 1fr;
      gap: 10px;
      align-items: start;
      animation: pop var(--t-slow) cubic-bezier(.2,.8,.2,1) 1;
    }
    @keyframes pop {
      0% { transform: translateY(6px); opacity: 0; }
      100% { transform: translateY(0); opacity: 1; }
    }

    .avatar {
      width: 36px;
      height: 36px;
      border-radius: 12px;
      background: linear-gradient(135deg, var(--brand), var(--brand-2));
      display: grid;
      place-items: center;
      color: white;
      font-weight: 900;
      letter-spacing: 0.4px;
      box-shadow: 0 8px 18px rgba(0,0,0,0.25);
      user-select: none;
    }
    .avatar.user {
      background: linear-gradient(135deg, #ff7e66, #ffc466);
    }
    .bubble {
      border: 1px solid var(--border);
      background: linear-gradient(180deg, var(--bg-elev), color-mix(in oklab, var(--bg-elev), black 2%));
      border-radius: 14px;
      padding: 10px 12px;
      box-shadow: 0 10px 20px var(--shadow);
    }
    .bubble.assistant {
      border-color: color-mix(in oklab, var(--border), var(--brand) 22%);
    }
    .bubble.user {
      border-color: color-mix(in oklab, var(--border), #ff9a7a 22%);
    }
    .meta {
      display: flex;
      align-items: center;
      gap: 10px;
      font-size: 12px;
      color: var(--muted);
      margin-top: 6px;
    }
    .tag {
      border: 1px solid var(--border);
      border-radius: 999px;
      padding: 2px 8px;
      font-weight: 700;
      color: var(--muted);
    }

    .typing {
      display: inline-flex;
      gap: 6px;
      align-items: center;
      color: var(--muted);
      font-size: 13px;
      opacity: 0;
      transform: translateY(4px);
      transition: opacity var(--t-med) ease, transform var(--t-med) ease;
    }
    .typing.visible {
      opacity: 1;
      transform: translateY(0);
    }
    .dots span {
      display: inline-block;
      width: 6px; height: 6px;
      border-radius: 50%;
      background: color-mix(in oklab, var(--text), var(--brand) 35%);
      animation: blink 1.2s infinite ease-in-out;
    }
    .dots span:nth-child(2) { animation-delay: .15s; }
    .dots span:nth-child(3) { animation-delay: .3s; }
    @keyframes blink {
      0%, 80%, 100% { transform: translateY(0); opacity: .35; }
      40% { transform: translateY(-2px); opacity: 1; }
    }

    .composer {
      border-top: 1px solid var(--border);
      padding: var(--g-md);
      background: linear-gradient(180deg, var(--bg), var(--bg-elev));
      display: grid;
      grid-template-columns: 1fr auto;
      gap: var(--g-md);
    }
    .input-wrap {
      display: grid;
      grid-template-columns: 1fr auto;
      gap: 8px;
      border: 1px solid var(--border);
      border-radius: var(--r-lg);
      background: linear-gradient(180deg, var(--bg-elev), var(--bg));
      padding: 6px;
      transition: border-color var(--t-med) ease;
    }
    .input-wrap:focus-within {
      border-color: color-mix(in oklab, var(--border), var(--brand) 40%);
    }
    textarea {
      background: transparent;
      color: var(--text);
      border: none;
      outline: none;
      resize: none;
      height: var(--input-h);
      padding: 10px 12px;
      font-family: var(--sans);
      font-size: 14px;
      line-height: 1.35;
    }
    .send {
      display: inline-flex;
      align-items: center;
      gap: 8px;
      padding: 0 14px;
      border-radius: var(--r-md);
      border: 1px solid color-mix(in oklab, var(--border), var(--brand) 45%);
      background: linear-gradient(180deg, color-mix(in oklab, var(--bg-elev), var(--brand) 14%), var(--bg-elev));
      color: var(--text);
      font-weight: 700;
      cursor: pointer;
      transition: transform var(--t-med) ease, border-color var(--t-med) ease, background var(--t-med) ease;
      box-shadow: 0 8px 18px rgba(124, 92, 255, 0.25);
    }
    .send:hover { transform: translateY(-1px); }
    .send:active { transform: translateY(0); }

    /* ===========================
       FAQ / PRIVACY / SETTINGS
       =========================== */

    .section-title {
      font-weight: 900;
      letter-spacing: .4px;
      margin-bottom: 10px;
    }
    .faq-item, .policy-item, .setting-item {
      border: 1px solid var(--border);
      background: linear-gradient(180deg, var(--bg-elev), var(--bg));
      border-radius: var(--r-lg);
      padding: 12px;
      margin-bottom: 12px;
      transition: border-color var(--t-med) ease, transform var(--t-med) ease;
    }
    .faq-item:hover, .policy-item:hover, .setting-item:hover {
      transform: translateY(-1px);
      border-color: color-mix(in oklab, var(--border), var(--brand) 20%);
    }
    .faq-q {
      font-weight: 800;
      margin-bottom: 6px;
    }
    .faq-a, .policy-text {
      color: var(--muted);
    }

    .toggle-row {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 12px;
    }
    .toggle-row .desc {
      color: var(--muted);
      font-size: 13px;
    }

    .segmented {
      display: inline-grid;
      grid-auto-flow: column;
      gap: 6px;
      background: linear-gradient(180deg, var(--bg), var(--bg-elev));
      border: 1px solid var(--border);
      border-radius: 999px;
      padding: 4px;
    }
    .segmented .seg {
      padding: 6px 10px;
      font-weight: 700;
      color: var(--muted);
      border-radius: 999px;
      cursor: pointer;
      user-select: none;
      transition: color var(--t-med) ease, background var(--t-med) ease;
    }
    .segmented .seg.active {
      color: var(--text);
      background: linear-gradient(180deg, var(--bg-elev), var(--bg));
      border: 1px solid var(--border);
      box-shadow: 0 4px 12px var(--shadow);
    }

    .small {
      font-size: 12px;
      color: var(--muted);
    }

    .hr {
      height: 1px;
      background: var(--border);
      margin: 10px 0;
    }

    .ghost {
      opacity: 0.45;
    }

    .link {
      color: color-mix(in oklab, var(--text), var(--brand) 35%);
      text-decoration: none;
      border-bottom: 1px dashed color-mix(in oklab, var(--border), var(--brand) 40%);
    }
    .link:hover {
      color: color-mix(in oklab, var(--text), var(--brand) 55%);
      border-bottom-style: solid;
    }

    @media (max-width: 980px) {
      .layout {
        grid-template-columns: 1fr;
        grid-template-rows: auto auto;
      }
      .sidebar {
        order: 2;
      }
      .chat {
        order: 1;
      }
    }
  </style>
</head>
<body>
  <div class="veil" aria-hidden="true"></div>

  <div class="app">
    <header class="header">
      <div class="brand">
        <div class="brand-logo" aria-hidden="true"></div>
        <div class="brand-name">ZIFI — локальный мини‑чат</div>
      </div>
      <div class="actions">
        <button class="btn theme-toggle" id="themeToggle" title="Переключить тему">Тема</button>
        <button class="btn" id="exportBtn" title="Экспорт истории">Экспорт</button>
        <button class="btn" id="importBtn" title="Импорт истории">Импорт</button>
        <a class="btn primary" href="#" id="clearBtn" title="Очистить историю">Очистить</a>
      </div>
    </header>

    <main class="layout">
      <aside class="panel sidebar">
        <nav class="tabs" id="tabs">
          <div class="tab active" data-tab="chat">Chat</div>
          <div class="tab" data-tab="faq">FAQ</div>
          <div class="tab" data-tab="privacy">Privacy</div>
          <div class="tab" data-tab="settings">Settings</div>
        </nav>
        <div class="sidebar-body" id="sidebarBody">
          <section data-view="chat" class="view active">
            <div class="section-title">Горячие подсказки</div>

            <div class="faq-item">
              <div class="faq-q">Суммаризировать текст</div>
              <div class="faq-a">Вставь абзац, добавь команду: "Сделай краткое резюме на 3 пункта".</div>
            </div>

            <div class="faq-item">
              <div class="faq-q">Улучшить формулировку</div>
              <div class="faq-a">Напиши: "Перефразируй более понятно, сохрани смысл и тон." </div>
            </div>

            <div class="faq-item">
              <div class="faq-q">Сгенерировать план</div>
              <div class="faq-a">Скажи: "Составь план из 5 шагов с рисками и критериями успеха."</div>
            </div>

            <div class="faq-item">
              <div class="faq-q">Поиск по истории</div>
              <div class="faq-a">Используй поле сверху справа или нажми Ctrl/Cmd+K.</div>
            </div>

            <div class="hr"></div>
            <div class="small">Все данные остаются только у тебя, в браузере. Подключений к сети нет.</div>
          </section>

          <section data-view="faq" class="view">
            <div class="section-title">FAQ — часто задаваемые вопросы</div>

            <div class="faq-item">
              <div class="faq-q">Зачем это приложение?</div>
              <div class="faq-a">Чтобы быстро фиксировать мысли, формулировать тексты и играться с идеями в одном окне без серверов.</div>
            </div>

            <div class="faq-item">
              <div class="faq-q">Какие есть ограничения?</div>
              <div class="faq-a">Это локальная демо‑версия. Ответы ассистента генерируются на клиенте упрощёнными правилами.</div>
            </div>

            <div class="faq-item">
              <div class="faq-q">Где хранится история?</div>
              <div class="faq-a">В localStorage твоего браузера. Можно экспортировать/импортировать JSON.</div>
            </div>

            <div class="faq-item">
              <div class="faq-q">Есть светлая/тёмная тема?</div>
              <div class="faq-a">Да, можно выбрать светлую, тёмную или «системную» — переключатель в Settings.</div>
            </div>
          </section>

          <section data-view="privacy" class="view">
            <div class="section-title">Политика и приватность</div>

            <div class="policy-item">
              <div class="policy-text">Приложение не отправляет данные никуда. История чата хранится локально на твоём устройстве. Ты сам контролируешь экспорт и очистку.</div>
            </div>

            <div class="policy-item">
              <div class="policy-text">Пожалуйста, не сохраняй здесь чувствительные или персональные данные, если ты не уверен в безопасности своего устройства и профиля браузера.</div>
            </div>

            <div class="policy-item">
              <div class="policy-text">Импорт/экспорт создаёт/читает файл формата JSON. Проверяй содержимое перед импортом.</div>
            </div>
          </section>

          <section data-view="settings" class="view">
            <div class="section-title">Настройки</div>

            <div class="setting-item">
              <div class="toggle-row">
                <div>
                  <div><strong>Тема интерфейса</strong></div>
                  <div class="desc">Светлая, тёмная или системная (по настройкам ОС).</div>
                </div>
                <div class="segmented" id="themeSeg">
                  <div class="seg" data-theme="light">Light</div>
                  <div class="seg active" data-theme="system">System</div>
                  <div class="seg" data-theme="dark">Dark</div>
                </div>
              </div>
            </div>

            <div class="setting-item">
              <div class="toggle-row">
                <div>
                  <div><strong>Режим компактных пузырей</strong></div>
                  <div class="desc">Уменьшает отступы сообщений и высоту строк.</div>
                </div>
                <label>
                  <input type="checkbox" id="compactToggle" />
                  Компактно
                </label>
              </div>
            </div>

            <div class="setting-item">
              <div class="toggle-row">
                <div>
                  <div><strong>Псевдо‑интеллектуальные ответы</strong></div>
                  <div class="desc">Включить немного «магии» в ответах ассистента (перефраз, советы, структура).</div>
                </div>
                <label>
                  <input type="checkbox" id="smartToggle" checked />
                  Смарт
                </label>
              </div>
            </div>

            <div class="setting-item">
              <div><strong>Шорткаты</strong></div>
              <div class="kbadge">Ctrl/Cmd + Enter</div> — отправить
              <br />
              <div class="kbadge">Ctrl/Cmd + K</div> — поиск
              <br />
              <div class="kbadge">Ctrl/Cmd + L</div> — очистить историю
            </div>
          </section>
        </div>
        <div class="sidebar-footer">
          <div class="small ghost">Локальный режим • v0.1</div>
          <div class="kbadge">ESC — фокус в поле ввода</div>
        </div>
      </aside>

      <section class="panel chat">
        <div class="chat-header">
          <div class="section-title">Диалог</div>
          <div class="search">
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" class="ghost"><path d="M21 21l-4.3-4.3" stroke-width="2" stroke-linecap="round"/><circle cx="10" cy="10" r="7" stroke-width="2"/></svg>
            <input id="searchInput" type="search" placeholder="Поиск по сообщениям..." />
            <div class="kbadge">Ctrl/Cmd + K</div>
          </div>
        </div>

        <div class="chat-scroll" id="chatScroll" aria-live="polite"></div>

        <div class="composer">
          <div class="input-wrap">
            <textarea id="composerInput" placeholder="Напиши сообщение..."></textarea>
            <div class="typing" id="typing">
              <div class="dots"><span></span><span></span><span></span></div>
              <div>печатает...</div>
            </div>
          </div>
          <button class="send" id="sendBtn" title="Отправить">Отправить ⏎</button>
        </div>
      </section>
    </main>
  </div>

  <template id="tpl-msg">
    <div class="msg">
      <div class="avatar"></div>
      <div>
        <div class="bubble"></div>
        <div class="meta">
          <div class="tag"></div>
          <div class="time"></div>
        </div>
      </div>
    </div>
  </template>

  <template id="tpl-date">
    <div class="date-divider">
      <div class="date-chip"></div>
    </div>
  </template>

  <input type="file" id="hiddenFile" accept="application/json" style="display:none" />

  <script>
    ;(() => {
      // ===========================
      // УТИЛИТЫ
      // ===========================
      const $ = (sel, root=document) => root.querySelector(sel);
      const $$ = (sel, root=document) => Array.from(root.querySelectorAll(sel));

      const formatTime = (ts) => {
        const d = new Date(ts);
        const hh = String(d.getHours()).padStart(2,'0');
        const mm = String(d.getMinutes()).padStart(2,'0');
        return hh + ':' + mm;
      };

      const formatDate = (ts) => {
        const d = new Date(ts);
        const dd = String(d.getDate()).padStart(2,'0');
        const mm = String(d.getMonth()+1).padStart(2,'0');
        const yyyy = d.getFullYear();
        return `${dd}.${mm}.${yyyy}`;
      };

      const uid = () => Math.random().toString(36).slice(2, 10);

      const saveJSON = (name, data) => {
        const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
        const a = document.createElement('a');
        a.href = URL.createObjectURL(blob);
        a.download = name;
        a.click();
        setTimeout(() => URL.revokeObjectURL(a.href), 1000);
      };

      const debounce = (fn, ms=250) => {
        let t;
        return (...args) => {
          clearTimeout(t);
          t = setTimeout(() => fn(...args), ms);
        };
      };

      const elFromTemplate = (tplId) => {
        const tpl = document.getElementById(tplId);
        return tpl.content.firstElementChild.cloneNode(true);
      };

      // ===========================
      // ХРАНИЛИЩЕ
      // ===========================
      const STORAGE_KEY = 'zifi_chat_v1';
      const PREFS_KEY = 'zifi_prefs_v1';

      const store = {
        load() {
          try {
            const raw = localStorage.getItem(STORAGE_KEY);
            if (!raw) return { messages: [] };
            const obj = JSON.parse(raw);
            if (!Array.isArray(obj.messages)) obj.messages = [];
            return obj;
          } catch(e) {
            console.warn('load error', e);
            return { messages: [] };
          }
        },
        save(data) {
          try {
            localStorage.setItem(STORAGE_KEY, JSON.stringify(data));
          } catch(e) {
            console.warn('save error', e);
          }
        },
        prefs: {
          load() {
            try {
              const raw = localStorage.getItem(PREFS_KEY);
              return raw ? JSON.parse(raw) : { theme: 'system', compact: false, smart: true };
            } catch(e) {
              return { theme: 'system', compact: false, smart: true };
            }
          },
          save(p) {
            try {
              localStorage.setItem(PREFS_KEY, JSON.stringify(p));
            } catch(e) {}
          }
        }
      };

      // ===========================
      // СОСТОЯНИЕ
      // ===========================
      const state = {
        messages: [],
        query: '',
        prefs: store.prefs.load(),
        typing: false,
        draft: ''
      };

      // ===========================
      // ТЕМА
      // ===========================
      const applyTheme = (mode) => {
        const root = document.documentElement;
        if (mode === 'system') {
          root.setAttribute('data-theme', 'system');
          const preferDark = window.matchMedia('(prefers-color-scheme: dark)').matches;
          root.setAttribute('data-theme', preferDark ? 'dark' : 'light'); // применяем, но храним system
          root.setAttribute('data-theme-mode', 'system');
          // После применения, снова назад в system для переменных по умолчанию
          setTimeout(() => root.setAttribute('data-theme', 'system'), 0);
        } else {
          root.setAttribute('data-theme', mode);
          root.setAttribute('data-theme-mode', mode);
        }
      };

      const initThemeFromPrefs = () => {
        applyTheme(state.prefs.theme || 'system');
        // Обновляем сегменты
        const segs = $$('#themeSeg .seg');
        segs.forEach(seg => {
          seg.classList.toggle('active', seg.dataset.theme === (state.prefs.theme || 'system'));
        });
      };

      // ===========================
      // РЕНДЕР
      // ===========================
      const chatScroll = $('#chatScroll');

      const clearChatView = () => {
        chatScroll.innerHTML = '';
      };

      const groupByDate = (messages) => {
        const map = new Map();
        for (const m of messages) {
          const key = formatDate(m.ts);
          if (!map.has(key)) map.set(key, []);
          map.get(key).push(m);
        }
        return map;
      };

      const renderMessages = (filter='') => {
        clearChatView();
        const q = (filter || '').trim().toLowerCase();
        const filtered = q ? state.messages.filter(m =>
          (m.text || '').toLowerCase().includes(q) ||
          (m.role || '').toLowerCase().includes(q)
        ) : state.messages;

        const grouped = groupByDate(filtered);
        for (const [date, items] of grouped) {
          // дата
          const dEl = elFromTemplate('tpl-date');
          $('.date-chip', dEl).textContent = date;
          chatScroll.appendChild(dEl);

          for (const m of items) {
            const el = elFromTemplate('tpl-msg');
            const av = $('.avatar', el);
            const bb = $('.bubble', el);
            const tag = $('.tag', el);
            const t = $('.time', el);

            av.textContent = m.role === 'assistant' ? 'Z' : 'U';
            av.classList.toggle('user', m.role === 'user');
            bb.classList.add(m.role === 'assistant' ? 'assistant' : 'user');

            if (state.prefs.compact) {
              bb.style.padding = '8px 10px';
              bb.style.borderRadius = '12px';
            }

            // поддержка mini-форматирования
            bb.innerHTML = renderMarkdownLite(m.text || '');

            tag.textContent = m.role === 'assistant' ? 'assistant' : 'user';
            t.textContent = formatTime(m.ts);

            chatScroll.appendChild(el);
          }
        }
        // прокрутка вниз
        requestAnimationFrame(() => chatScroll.scrollTo({ top: chatScroll.scrollHeight, behavior: 'smooth' }));
      };

      // Мини‑парсер для простых markdown‑паттернов
      const renderMarkdownLite = (s) => {
        let html = (s || '')
          .replace(/&/g, '&amp;')
          .replace(/</g, '&lt;')
          .replace(/>/g, '&gt;');

        // bold **text**
        html = html.replace(/\*\*(.+?)\*\*/g, '<strong>$1</strong>');
        // inline code `code`
        html = html.replace(/`([^`]+?)`/g, '<code style="font-family: var(--mono); font-size: 90%;">$1</code>');
        // bullet points
        html = html.replace(/(^|\n)- (.+)/g, '$1• $2');
        // simple links [text](url)
        html = html.replace(/

\[([^\]

]+)\]

\((https?:\/\/[^\s)]+)\)/g, '<a class="link" target="_blank" rel="noopener" href="$2">$1</a>');
        // newlines
        html = html.replace(/\n/g, '<br/>');
        return html;
      };

      // ===========================
      // ИНИЦИАЛИЗАЦИЯ
      // ===========================
      const data = store.load();
      state.messages = data.messages || [];
      state.draft = localStorage.getItem('zifi_draft') || '';

      const composer = $('#composerInput');
      composer.value = state.draft;

      const searchInput = $('#searchInput');
      searchInput.value = state.query;

      initThemeFromPrefs();
      renderMessages();

      // приветствие при пустой истории
      if (state.messages.length === 0) {
        addAssistant("Привет! Я здесь, чтобы помогать тебе формулировать мысли. Расскажи, что крутится в голове — начнём с малого.");
      }

      // ===========================
      // СОБЫТИЯ: ТАБЫ, НАСТРОЙКИ
      // ===========================
      $('#tabs').addEventListener('click', (e) => {
        const tab = e.target.closest('.tab');
        if (!tab) return;
        $$('.tab').forEach(t => t.classList.remove('active'));
        tab.classList.add('active');

        const name = tab.dataset.tab;
        $$('.view', $('#sidebarBody')).forEach(v => v.classList.remove('active'));
        $(`.view[data-view="${name}"]`, $('#sidebarBody')).classList.add('active');
      });

      $('#themeToggle').addEventListener('click', () => {
        const order = ['system', 'light', 'dark'];
        const cur = state.prefs.theme || 'system';
        const idx = order.indexOf(cur);
        const next = order[(idx + 1) % order.length];
        state.prefs.theme = next;
        store.prefs.save(state.prefs);
        applyTheme(next);
        // обновить сегменты
        $$('#themeSeg .seg').forEach(seg => seg.classList.toggle('active', seg.dataset.theme === next));
      });

      $('#themeSeg').addEventListener('click', (e) => {
        const seg = e.target.closest('.seg');
        if (!seg) return;
        $$('#themeSeg .seg').forEach(s => s.classList.remove('active'));
        seg.classList.add('active');
        const mode = seg.dataset.theme;
        state.prefs.theme = mode;
        store.prefs.save(state.prefs);
        applyTheme(mode);
      });

      $('#compactToggle').addEventListener('change', (e) => {
        state.prefs.compact = !!e.target.checked;
        store.prefs.save(state.prefs);
        renderMessages(state.query);
      });

      $('#smartToggle').addEventListener('change', (e) => {
        state.prefs.smart = !!e.target.checked;
        store.prefs.save(state.prefs);
      });

      // ===========================
      // ПОИСК
      // ===========================
      const doSearch = debounce((v) => {
        state.query = v;
        renderMessages(v);
      }, 200);
      searchInput.addEventListener('input', (e) => doSearch(e.target.value));

      // ===========================
      // КОМПОЗЕР
      // ===========================
      const sendBtn = $('#sendBtn');
      const typingEl = $('#typing');

      const setTyping = (flag) => {
        state.typing = flag;
        typingEl.classList.toggle('visible', flag);
      };

      const persist = () => store.save({ messages: state.messages });

      const addMessage = (role, text) => {
        const m = { id: uid(), role, text, ts: Date.now() };
        state.messages.push(m);
        persist();
        renderMessages(state.query);
      };

      const addUser = (text) => addMessage('user', text);
      const addAssistant = (text) => addMessage('assistant', text);

      const handleSend = () => {
        const text = (composer.value || '').trim();
        if (!text) return;
        addUser(text);
        composer.value = '';
        state.draft = '';
        localStorage.removeItem('zifi_draft');
        emulateAssistantReply(text);
      };

      sendBtn.addEventListener('click', handleSend);
      composer.addEventListener('keydown', (e) => {
        if ((e.ctrlKey || e.metaKey) && e.key === 'Enter') {
          e.preventDefault();
          handleSend();
          return;
        }
        if (e.key === 'Escape') {
          e.preventDefault();
          composer.blur();
        }
      });
      composer.addEventListener('input', (e) => {
        state.draft = e.target.value || '';
        localStorage.setItem('zifi_draft', state.draft);
      });

      // ===========================
      // ЭКСПОРТ/ИМПОРТ, ОЧИСТКА
      // ===========================
      $('#exportBtn').addEventListener('click', () => {
        const payload = {
          type: 'zifi-chat-export',
          version: 1,
          exportedAt: new Date().toISOString(),
          messages: state.messages
        };
        const name = `zifi_export_${Date.now()}.json`;
        saveJSON(name, payload);
      });

      const fileInput = $('#hiddenFile');
      $('#importBtn').addEventListener('click', () => fileInput.click());
      fileInput.addEventListener('change', async (e) => {
        const file = e.target.files && e.target.files[0];
        if (!file) return;
        try {
          const text = await file.text();
          const data = JSON.parse(text);
          if (data && Array.isArray(data.messages)) {
            state.messages = data.messages
              .filter(m => m && typeof m.text === 'string' && (m.role === 'user' || m.role === 'assistant'))
              .map(m => ({
                id: m.id || uid(),
                role: m.role,
                text: m.text,
                ts: typeof m.ts === 'number' ? m.ts : Date.now()
              }))
              .sort((a, b) => a.ts - b.ts);
            persist();
            renderMessages(state.query);
          } else {
            alert('Неверный формат файла.');
          }
        } catch (err) {
          alert('Ошибка импорта: ' + err.message);
        } finally {
          e.target.value = '';
        }
      });

      const clearAll = () => {
        if (!confirm('Точно очистить всю историю?')) return;
        state.messages = [];
        persist();
        renderMessages(state.query);
        addAssistant("История очищена. С чистого листа иногда получается смелее.");
      };
      $('#clearBtn').addEventListener('click', (e) => {
        e.preventDefault();
        clearAll();
      });

      // ===========================
      // ШОРТКАТЫ
      // ===========================
      document.addEventListener('keydown', (e) => {
        // Ctrl/Cmd+k => поиск
        if ((e.ctrlKey || e.metaKey) && e.key.toLowerCase() === 'k') {
          e.preventDefault();
          $('#searchInput').focus();
          $('#searchInput').select();
          return;
        }
        // Ctrl/Cmd+l => очистка
        if ((e.ctrlKey || e.metaKey) && e.key.toLowerCase() === 'l') {
          e.preventDefault();
          clearAll();
          return;
        }
      });

      // ===========================
      // ЭМУЛЯТОР ОТВЕТОВ
      // ===========================
      function emulateAssistantReply(userText) {
        setTyping(true);

        const delay = clamp(600 + userText.length * 12, 800, 2400);
        const make = state.prefs.smart ? smartRespond : plainRespond;

        setTimeout(() => {
          const reply = make(userText);
          addAssistant(reply);
          setTyping(false);
        }, delay);
      }

      function clamp(x, a, b) { return Math.max(a, Math.min(b, x)); }

      function plainRespond(s) {
        if (!s) return "Расскажи чуть больше — я рядом.";
        if (s.length < 40) {
          return "Понимаю. " + mirror(s) + " Хочешь, разложим на 3 шага?";
        }
        return "Сводка: " + summarize(s, 2) + "\n\nДобавь деталей, если нужно докрутить.";
      }

      function smartRespond(s) {
        // Небольшой "коктейль" эвристик: резюме, вопросы, мягкая обратная связь
        const bullets = [
          "Суть: " + summarize(s, 1),
          "Где риск: " + riskify(s),
          "Первый шаг: " + firstStep(s)
        ].map((x, i) => `- ${x}`).join('\n');

        const tone = choose([
          "Звучит жизненно. ",
          "Это важно. ",
          "Тут есть энергия. ",
          "Чувствуется твоя мотивация. "
        ]);

        const ask = choose([
          "Что для тебя будет «готово»?",
          "Какая деталь больше всего тревожит?",
          "Что усложняет первый шаг?",
          "Чем успех будет отличаться от «просто сделано»?"
        ]);

        return `${tone}${mirror(s)}\n\n${bullets}\n\nВопрос: ${ask}`;
      }

      function mirror(s) {
        const trimmed = s.trim().replace(/\s+/g, ' ');
        if (trimmed.length > 120) return trimmed.slice(0, 120) + '…';
        return trimmed;
      }

      function summarize(s, n=3) {
        // Наивная "суммаризация": берём ключевые слова по частоте, строим короткую фразу
        const words = s.toLowerCase().replace(/[^\p{L}\p{N}\s]/gu, '').split(/\s+/).filter(Boolean);
        const stop = new Set(['и','в','на','но','что','это','как','к','по','за','с','о','а','или','у','не','из','то','для','же','мы','ты','я','он','она','они','бы','быть','есть','нет']);
        const freq = new Map();
        for (const w of words) {
          if (stop.has(w)) continue;
          freq.set(w, (freq.get(w) || 0) + 1);
        }
        const top = [...freq.entries()].sort((a,b) => b[1]-a[1]).slice(0, Math.max(1, n)).map(([w]) => w);
        if (top.length === 0) return 'кратко: без ключевых слов';
        return 'кратко: ' + top.join(', ');
      }

      function riskify(s) {
        const hints = [
          'размытая цель',
          'слишком общий план',
          'отсутствие дедлайна',
          'мало обратной связи',
          'перегруженность задачами'
        ];
        return choose(hints);
      }

      function firstStep(s) {
        const options = [
          'зафиксировать результат в 1–2 предложениях',
          'создать чек‑лист из 3 пунктов',
          'поставить таймер на 20 минут',
          'наметить крайний срок и критерий успеха',
          'попросить отзыв у знакомого'
        ];
        return choose(options);
      }

      function choose(arr) { return arr[Math.floor(Math.random() * arr.length)]; }

      // ===========================
      // ФОКУСЫ И УДОБСТВА
      // ===========================
      // При старте: фокус в композер
      setTimeout(() => composer.focus(), 200);

      // Клик по панели чата — фокус на поле ввода
      $('#chatScroll').addEventListener('click', () => composer.focus());

      // Обработка системной темы
      const media = window.matchMedia('(prefers-color-scheme: dark)');
      media.addEventListener?.('change', () => {
        if ((state.prefs.theme || 'system') === 'system') {
          applyTheme('system');
        }
      });
    })();
  </script>
</body>
</html>
"""